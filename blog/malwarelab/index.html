<!DOCTYPE html>
<html lang="en-us">

<head>
    <title>
Malware Lab | Cambie ツ
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Creating your own lab for malware analysis using Qemu/KVM.">

<meta name="generator" content="Hugo 0.143.1">


<link rel="canonical" href="/blog/malwarelab/" >
<link rel="icon" href="/cambie/favicon/radioactive.png" type="image/png">




<link href="/css/style.min.5c1fa9bba2d0e854fe30b3d6316ab0114a2a5f25c9a98275badeadb66f2ec725.css" rel="stylesheet">




</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a class="terminal" href="/">
                <span>cambie@malbian ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="/about" title="" >
                        ~/about</a>
                </li>
                
                <li>
                    <a href="/malbian" title="" >
                        ~/malbian</a>
                </li>
                
                <li>
                    <a href="/donate" title="" >
                        ~/donate</a>
                </li>
                
                <li>
                    <a href="/blog" title="" >
                        ~/blog</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
    <h1>Malware Lab</h1>
    
    	<p>Creating your own lab for malware analysis using Qemu/KVM.</p>
    
    
    <section class="postMetadata">
        <dl>
            
            
            
            
                <dt>published</dt>
                
                <dd><time datetime="2025-01-15">January 15, 2025</time></dd>
            
            
                <dt>reading time</dt>
                <dd>4 minutes</dd>
            
        </dl>
    </section>
    
    <div>
        <p>One of the key aspects of analyzing malware is having a safe environment in which we can detonate malware without any danger. In this guide we&rsquo;ll set up our own lab using qemu/kvm stack.</p>
<p>Let&rsquo;s start with the basics.</p>
<h3 id="what-is-kvm-qemu-and-libvirt-">What is KVM, Qemu and libvirt ?</h3>
<p>These three components are system tools, services or features that enable us to virtualize.</p>
<ul>
<li><strong>KVM (Kernel-based Virtual Machine)</strong> is an open source virtualization technology for Linux OS. It allows Linux to function as a hypervisor that runs multiple, isolated VMs.</li>
<li><strong>Qemu (Quick Emulator)</strong> is a generic and open source machine emulator and virtualizer. The most common use is for System Emulation, where it provides hardware such as Disk, network and USB. Even though the CPU can be fully emulated, it may work with a hypervisor like KVM to allow the guest to run directly on the host CPU.</li>
<li><strong>libvirt</strong> is an opensource API, daemon and management tool for managing platform virtualization. It can be used to manage KVM, Xen, VM-Ware, Qemu, etc. APIs are consumed by client tools for provisioning and managing VMs.</li>
</ul>
<h3 id="why-qemu">Why qemu?</h3>
<p>In my experience qemu is insanely fast and incredibly reliable when it comes to virtualization.</p>
<p>The stack starts with KVM that is placed basically at the kernel level allowing almost native CPU perforance on the VMs, then we have qemu that will basically let us emulate resources and manage them easily. At last we&rsquo;ll have libvirt which will let us interact with the VMs we created through APIs.
Cool, but how do we use all this stuff?
The client tool we&rsquo;ll be using with this stack is called <strong>virt-manager</strong>. This application will allow us to manage KVM virtual machines through libvirt, it&rsquo;s a GUI alternative to <strong>virsh</strong> and it contains a VNC and SPICE client for direct graphical access to VMs.</p>
<p>If you don&rsquo;t know how to build or install qemu you can <a href="https://www.qemu.org/download/">check it here!</a></p>
<p>In order to install virt-manager you can <a href="https://virt-manager.org/download.html">check it here!</a></p>
<hr>
<p>Something I like to do is having an alias set in my ~/.zshrc file in order to deploy a fast VM with a NAT Network for whenever I need to do some quick downloads, installing packages, update and upgrade a system. First, I like stacking all my image and ISOs in /var/lib/libvirt/images directory. That way i keep everything somewhat organized. To make an image we can simply use virt-manager and create a new virtual machine using an ISO, but i like creating mine from the command line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /var/lib/libvirt/images
</span></span><span style="display:flex;"><span>sudo qemu-img create -f qcow2 &lt;imageName.img&gt; &lt;sieze_of_image&gt;
</span></span></code></pre></div><p>After this creation we can boot our ISO image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo qemu-system-x86_64 -enable-kvm -cdrom &lt;/path/to/your/OS.iso&gt; -boot menu<span style="color:#f92672">=</span>on -drive file<span style="color:#f92672">=</span>&lt;/path/to/imageName.img&gt; -m 4G -cpu host -smp <span style="color:#ae81ff">2</span> -vga virtio -display sdl,gl<span style="color:#f92672">=</span>on
</span></span></code></pre></div><p>After installation I would then add an alias to my zshrc as said before, for example this is what I have:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>alias malbian<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sudo qemu-system-x86_64 -enable-kvm -boot menu=on -drive file=/var/lib/libvirt/images/malbianXfceImage.img -m 4G -cpu host -smp 2 -vga virtio -display sdl,show-cursor=on&#39;</span>
</span></span></code></pre></div><p>This way I can just type &lsquo;malbian&rsquo; as if it were a command and I can run my VM from the command line!</p>
<hr>
<p>Okay so, for malware we don&rsquo;t need a NAT Network format, we kinda need a super private network where only the guests can communicate with each other and ignore the host completely. To do this we need to create a special Isolated Network:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-XML" data-lang="XML"><span style="display:flex;"><span><span style="color:#f92672">&lt;network&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;name&gt;</span>Private<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;uuid&gt;</span>d6b7b5fd-cf36-4f3d-acae-d7a384582398<span style="color:#f92672">&lt;/uuid&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;bridge</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;virbr2&#34;</span> <span style="color:#a6e22e">stp=</span><span style="color:#e6db74">&#34;on&#34;</span> <span style="color:#a6e22e">delay=</span><span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;mac</span> <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#34;52:54:00:4e:ce:dd&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;domain</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Private&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/network&gt;</span>
</span></span></code></pre></div><p>Note: To do this you need to go to &lsquo;Edit &gt; Connection Details &gt; Virtual Networks Tab&rsquo; and down click the plus sign.</p>
<p>This is the simplest way to do it, that&rsquo;s why we follow <a href="https://libvirt.org/formatnetwork.html#network-config-with-no-gateway-addresses">libvirt&rsquo;s configuration</a>. This also means that we won&rsquo;t have DHCP enabled, but thats no problem we can set our IP Addresses manually or add another VM to work as a DHCP server. In my case, I like to set up the IPs manually.</p>
<p>Okay, now that we have our network setup we need to run our VMs and set their IP address. I normally run a <a href="https://github.com/MalbianLinux">Malbian Linux</a> instance and a Windows 10 Instance. In our Guest Linux Machine (Malbian) we&rsquo;re gonna set our desired IP addres after stopping the NetworkManager daemon down:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl stop NetworkManager
</span></span><span style="display:flex;"><span>sudo ip addr add 10.10.10.3/24 dev enp1s0
</span></span></code></pre></div><p>For windows, we&rsquo;ll do the same but in a gui format cause you know&hellip; it&rsquo;s windows:</p>
<p><img src="/malwarelab/malwarelab1.png" alt="Image 1"></p>
<p>Note that we already stablished the DNS pointing towards our Linux box, this is so we can run INetSim effectively.</p>
<p>That&rsquo;s all, now we have communication between the windows box and linux box:</p>
<p><img src="/malwarelab/malwarelab2.png" alt="Image 2"></p>
<p>And between Linux and Windows:</p>
<p><img src="/malwarelab/malwarelab3.png" alt="Image 3"></p>
<p>Looking at our Host machine, we can see that we don&rsquo;t have any ip address in that &lsquo;virbr2&rsquo; interface, so we can&rsquo;t communicate with it:</p>
<p><img src="/malwarelab/malwarelab4.png" alt="Image 4"></p>
<p>However, as you can see, we can set up an ip if we like so we can communicate with our guest machines:</p>
<p><img src="/malwarelab/malwarelab5.png" alt="Image 5"></p>
<p><img src="/malwarelab/malwarelab6.png" alt="Image 6"></p>
<p>I cover this just in case you need it, but it&rsquo;s obviously not recommended. We can revert this change and go back to the previous config:</p>
<p><img src="/malwarelab/malwarelab7.png" alt="Image 7"></p>

    </div>
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>
            © 2025 Cambie ツ
        </span>
    
</footer>

    </div>

</body>

</html>